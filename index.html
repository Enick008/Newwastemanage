<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบติดตามโครงการขนมูลฝอย</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; }
    .tab-button.active { background-color: #dc2626; color: white; }
  </style>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YOUR_MEASUREMENT_ID"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-YOUR_MEASUREMENT_ID');
  </script>

</head>
<body class="bg-gray-100">
  <header class="text-center py-6 bg-red-600 text-white text-2xl font-bold">ระบบติดตามโครงการขนมูลฝอย 2568-2570</header>

  <div class="max-w-6xl mx-auto p-4">
    <div class="flex justify-center gap-4 mb-6">
      <button onclick="switchTab('form', 'บันทึกข้อมูล')" class="tab-button px-4 py-2 rounded-lg bg-white shadow">บันทึกข้อมูล</button>
      <button onclick="switchTab('stats', 'สถิติ')" class="tab-button px-4 py-2 rounded-lg bg-white shadow">สถิติ</button>
    </div>

    <div id="form" class="tab-content">
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-4">บันทึกงวดงาน</h2>
        <form id="recordForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="number" placeholder="งวดที่" id="period" required class="border p-2 rounded">
          <input type="date" placeholder="วันที่ครบงวด" id="dueDate" required class="border p-2 rounded">
          <input type="date" placeholder="วันที่ส่งงานจริง" id="submitDate" required class="border p-2 rounded">
          <input type="number" placeholder="จำนวนวันล่าช้า" id="delayDays" required class="border p-2 rounded" oninput="autoCalculateFine()">
          <input type="number" placeholder="ค่าปรับ (บาท)" id="fine" step="0.01" required class="border p-2 rounded">
          <input type="number" placeholder="ปริมาณขยะ (ตัน)" id="waste" step="0.01" required class="border p-2 rounded">
          <input type="text" placeholder="หมายเหตุเพิ่มเติม" id="note" class="border p-2 rounded">
          <button type="submit" class="col-span-2 bg-red-600 text-white py-2 rounded hover:bg-red-700">บันทึก</button>
        </form>
      </div>
    </div>

    <div id="stats" class="tab-content hidden">
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-4">สถิติ</h2>
        <canvas id="wasteChart" class="mb-6"></canvas>
        <canvas id="netPayChart" class="mb-6"></canvas>
        <canvas id="fineChart" class="mb-6"></canvas>
        <div id="summary" class="mt-6 text-lg"></div>
      </div>
    </div>
  </div>

  <script>
    const records = [];
    const fullBudget = 256122000;
    const pricePerTon = 1530;
    const finePerDay = 25612.20;
    const targetTons = 167400;
    const endpoint = 'https://script.google.com/macros/s/AKfycbwSBBtS6QVE1aLsyKuoVFXE7SJ2xpfcWS23HEe-d_d7GnG-DctZOUDo03XAUWtMXb6E/exec';

    function calculateStartDate(period) {
      const start = new Date("2025-05-07");
      start.setDate(start.getDate() + (period - 1) * 30);
      return start;
    }

    function autoCalculateFine() {
      const delayDays = parseInt(document.getElementById('delayDays').value) || 0;
      const fine = delayDays * finePerDay;
      document.getElementById('fine').value = fine.toFixed(2);
    }

    document.getElementById('recordForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const period = parseInt(document.getElementById('period').value);
      const submitDate = document.getElementById('submitDate').value;
      const dueDate = document.getElementById('dueDate').value;
      const delayDays = parseInt(document.getElementById('delayDays').value);
      const fine = parseFloat(document.getElementById('fine').value);
      const waste = parseFloat(document.getElementById('waste').value);
      const note = document.getElementById('note').value;

      const startDate = calculateStartDate(period);
      const startDateStr = startDate.toISOString().split('T')[0];

      const pay = waste * pricePerTon;
      const netPay = pay - fine;
      const wasteTotal = (records.reduce((sum, r) => sum + r.waste, 0)) + waste;
      const fineTotal = (records.reduce((sum, r) => sum + r.fine, 0)) + fine;
      const remainBudget = fullBudget - ((records.reduce((sum, r) => sum + r.netPay, 0)) + netPay);

      const data = {
        period,
        startDate: startDateStr,
        dueDate,
        submitDate,
        delayDays,
        fine,
        waste,
        note,
        pay,
        netPay,
        wasteTotal,
        fineTotal,
        remainBudget
      };

      const res = await fetch(endpoint, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await res.json();
      if (result.success) {
        alert('บันทึกลง Google Sheet สำเร็จ');
        document.getElementById('recordForm').reset();
        records.push(data);
        renderChart();
        // GA4 Event: Track successful form submission
        gtag('event', 'form_submission', {
          'event_category': 'form',
          'event_label': 'บันทึกงวดงานสำเร็จ',
          'period': period,
          'waste_amount': waste
        });
      } else {
        alert('เกิดข้อผิดพลาดในการบันทึก');
        // GA4 Event: Track failed form submission
        gtag('event', 'form_submission_failed', {
          'event_category': 'form',
          'event_label': 'บันทึกงวดงานไม่สำเร็จ',
          'period': period
        });
      }
    });

    function switchTab(tab, tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(tab).classList.remove('hidden');
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // GA4 Event: Track tab switch
      gtag('event', 'tab_switch', {
        'event_category': 'navigation',
        'event_label': `สลับไปแท็บ ${tabName}`,
        'tab_name': tabName
      });
    }

    function renderChart() {
      const labels = records.map(r => `งวดที่ ${r.period}`);
      const wasteData = records.map(r => r.waste);
      const netPayData = records.map(r => r.netPay);
      const fineData = records.map(r => r.fine);

      new Chart(document.getElementById('wasteChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'ปริมาณขยะ (ตัน)', data: wasteData }]
        },
        options: { responsive: true }
      });

      new Chart(document.getElementById('netPayChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'ค่าจ้างสุทธิ (บาท)', data: netPayData, backgroundColor: '#10b981' }]
        },
        options: { responsive: true }
      });

      new Chart(document.getElementById('fineChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'ค่าปรับ (บาท)', data: fineData, backgroundColor: '#ef4444' }]
        },
        options: { responsive: true }
      });

      const last = records[records.length - 1];
      const totalPay = records.reduce((sum, r) => sum + r.pay, 0);
      const totalNet = records.reduce((sum, r) => sum + r.netPay, 0);

      document.getElementById('summary').innerHTML = `
        <p>ปริมาณขยะสะสม: <strong>${last.wasteTotal.toFixed(2)}</strong> ตัน / ${targetTons} ตัน</p>
        <p>ค่าปรับสะสม: <strong>${last.fineTotal.toLocaleString()}</strong> บาท</p>
        <p>ค่าจ้างรวม (ก่อนหัก): <strong>${totalPay.toLocaleString()}</strong> บาท</p>
        <p>ค่าจ้างสุทธิรวม: <strong>${totalNet.toLocaleString()}</strong> บาท</p>
        <p>งบประมาณคงเหลือ: <strong>${last.remainBudget.toLocaleString()}</strong> บาท</p>
        <p>จำนวนงวดที่ส่งล่าช้า: <strong>${records.filter(r => r.delayDays > 0).length}</strong> งวด</p>
      `;
    }
  </script>
</body>
</html>
